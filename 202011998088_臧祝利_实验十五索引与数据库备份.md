# 实验十五 索引与数据库备份

|  姓名  |     学号     |     学院     |    日期    |
| :----: | :----------: | :----------: | :--------: |
| 臧祝利 | 202011998088 | 人工智能学院 | 2022.11.28 |

## 实验目的

(1) 了解什么是索引；

(2) 掌握创建索引的方法和技巧，熟悉如何删除索引；

(3) 了解数据备份和还原的概念；

(4) 掌握各种数据备份和还原的方法；

(5) 掌握加密算法；

## 实验内容

(1) 创建索引：使用 SQL 语句创建唯一索引、普通索引、组合索引；重命名索引；删除索引；

(2) 数据备份与数据还原；

(3) 加密算法

## 实验思路

(1) 在数据库turingaward 中创建数据表 turing。

Step1. 创建数据库`Labs15`，选择其“架构”，选择其中的“表”，右击选择新建表；

<img src="https://noteimg-12138.oss-cn-beijing.aliyuncs.com/img/202211281927797.png" alt="image-20221128192757718" style="zoom:80%;" />

Step2. 设置表的属性；

<img src="https://noteimg-12138.oss-cn-beijing.aliyuncs.com/img/202211281924756.png" alt="image-20221128192415525" style="zoom:80%;" />

<img src="https://noteimg-12138.oss-cn-beijing.aliyuncs.com/img/202211281927169.png" alt="image-20221128192742027" style="zoom:80%;" />

(2) 向turing表中插入数据。 

Step1. 右击`turing`表，选择查看/编辑数据中的所有行；

<img src="https://noteimg-12138.oss-cn-beijing.aliyuncs.com/img/202211281929975.png" alt="image-20221128192915875" style="zoom:80%;" />

Step2. 添加数据，点击①添加行，点击②进行保存；

<img src="https://noteimg-12138.oss-cn-beijing.aliyuncs.com/img/202211281931709.png" alt="image-20221128193153609" style="zoom:80%;" />

(3) 在贡献领域attribution上创建普通索引attribution_index。

输入以下代码：

```sql
create index attribution_index on turing(attribution);
```

若成功，如图所示：

<img src="https://noteimg-12138.oss-cn-beijing.aliyuncs.com/img/202211281935359.png" alt="image-20221128193512274" style="zoom:80%;" />

右击，选择属性，查看定义信息；

<img src="https://noteimg-12138.oss-cn-beijing.aliyuncs.com/img/202211281936559.png" alt="image-20221128193606439" style="zoom:80%;" />

(4) 在award_id上创建唯一索引unique_id_index。

执行代码：

```sql
create unique index unique_id_index on turing(award_id);
```

成功后如图所示：

<img src="https://noteimg-12138.oss-cn-beijing.aliyuncs.com/img/202211281938569.png" alt="image-20221128193840492" style="zoom:80%;" />

右击查看属性，唯一性被标注；

<img src="https://noteimg-12138.oss-cn-beijing.aliyuncs.com/img/202211281938469.png" alt="image-20221128193810338" style="zoom:80%;" />

(5) 在award_name和award_date上创建组合索引comb_name_date_index。 

执行代码：

```sql
create index comb_name_date_index on turing(award_name,award_data);
```

执行成功如图所示：

<img src="https://noteimg-12138.oss-cn-beijing.aliyuncs.com/img/202211281941147.png" alt="image-20221128194118064" style="zoom:80%;" />

右击查看属性：

<img src="https://noteimg-12138.oss-cn-beijing.aliyuncs.com/img/202211281941103.png" alt="image-20221128194147978" style="zoom:80%;" />

(6) 将索引unique_id_index重命名为uniqueidindex。

执行代码：

```sql
alter index unique_id_index rename to uniqueidindex;
```

执行成功后：

<img src="https://noteimg-12138.oss-cn-beijing.aliyuncs.com/img/202211281944664.png" alt="image-20221128194427607" style="zoom:80%;" />

右击查看属性：

<img src="https://noteimg-12138.oss-cn-beijing.aliyuncs.com/img/202211281944586.png" alt="image-20221128194450464" style="zoom:80%;" />

(7) 将索引comb_name_date_index删除。

执行代码：

```sql
drop index comb_name_date_index;
```

运行结果如下：

<img src="https://noteimg-12138.oss-cn-beijing.aliyuncs.com/img/202211281946876.png" alt="image-20221128194606778" style="zoom:80%;" />

(8) 查询turing表中attribution为“web”的信息，并显示执行命令和显示实际运行时间。

执行代码:

```sql
explain analyse SELECT * FROM turing
WHERE attribution = 'web';
```

结果如下：

<img src="https://noteimg-12138.oss-cn-beijing.aliyuncs.com/img/202211281950163.png" alt="image-20221128195035102" style="zoom:80%;" />

(9) 使用索引查询turing表中attribution为“web”的信息，并与问题(8)的查询速度做比较。

执行代码：

```sql
explain SELECT * FROM turing
WHERE attribution = 'web';
```

执行结果：

<img src="https://noteimg-12138.oss-cn-beijing.aliyuncs.com/img/202211281957325.png" alt="image-20221128195740226" style="zoom:80%;" />

并没有使用索引，因为表太小，规划器认为不需要索引扫描，因此==强制使用索引进行查询==；

执行代码：

<img src="https://noteimg-12138.oss-cn-beijing.aliyuncs.com/img/202211281959205.png" alt="image-20221128195908139" style="zoom:80%;" />

**可以发现其中`cost`增加，说明使用索引扫描时间增加，原因是表太小，增加的cpu时间显得更多**

(10) 用 pgAdmin 备份数据库 `exam_system`，删除数据库，并使用 pgAdmin 将其还原。

Step1. 右击数据库，点击“备份”；

<img src="https://noteimg-12138.oss-cn-beijing.aliyuncs.com/img/202211282003501.png" alt="image-20221128200357394" style="zoom:80%;" />

==<a id="error">出现错误！</a>==

<img src="https://noteimg-12138.oss-cn-beijing.aliyuncs.com/img/202211282005060.png" alt="image-20221128200517963" style="zoom:80%;" />

查询后，发现需要更改路径，选择文件

<img src="https://noteimg-12138.oss-cn-beijing.aliyuncs.com/img/202211282005600.png" alt="image-20221128200555516" style="zoom:80%;" />

选择“路径”，“二进制路径”，将postgresql的路径选中，保存；

<img src="https://noteimg-12138.oss-cn-beijing.aliyuncs.com/img/202211282011932.png" alt="image-20221128201125787" style="zoom:80%;" />

再次备份，成功，输入文件名；

<img src="https://noteimg-12138.oss-cn-beijing.aliyuncs.com/img/202211282012361.png" alt="image-20221128201220243" style="zoom:80%;" />

<img src="https://noteimg-12138.oss-cn-beijing.aliyuncs.com/img/202211282014934.png" alt="image-20221128201455846" style="zoom:80%;" />

Step2. 恢复数据库，新建一个空数据库`Labs15_copy`;

选择文件路径：

<img src="https://noteimg-12138.oss-cn-beijing.aliyuncs.com/img/202211282021027.png" alt="image-20221128202131932" style="zoom:80%;" />

<img src="https://noteimg-12138.oss-cn-beijing.aliyuncs.com/img/202211282021299.png" alt="image-20221128202149214" style="zoom:80%;" />

查看数据库内容，成功恢复；

<img src="https://noteimg-12138.oss-cn-beijing.aliyuncs.com/img/202211282022278.png" alt="image-20221128202221177" style="zoom:80%;" />

(11) 对字符串“I love database”使用MD5加密算法，返回加密结果；

先执行如下代码：

```sql
create extension pgcrypto;
```

再使用MD5进行加密：

```sql
SELECT MD5('I love database');
```

结果如下：

<img src="https://noteimg-12138.oss-cn-beijing.aliyuncs.com/img/202211282031012.png" alt="image-20221128203153933" style="zoom:80%;" />

(12) 用AES算法、以字符串“datebase”做密钥，对“abcdef”的对称加密, 输出加密密文，再对密文进行解密，还原出“abcdef”。

执行以下代码进行加密：

```sql
SELECT encode(encrypt('abcdef','datebase','aes'),'hex');
```

加密结果如下：

<img src="https://noteimg-12138.oss-cn-beijing.aliyuncs.com/img/202211282034964.png" alt="image-20221128203450873" style="zoom:80%;" />

执行以下代码进行解密：

```sql
SELECT convert_from(decrypt(decode('83b78dcbd0503d3420de40ae0ee6ee6d','hex'),'datebase','aes'),'SQL_ASCII');
```

解密结果如下：

<img src="https://noteimg-12138.oss-cn-beijing.aliyuncs.com/img/202211282036515.png" alt="image-20221128203633426" style="zoom:80%;" />

## 实验结果

==见实验思路==

## 源代码

==见实验思路==

## 思考题

（1）索引对数据库性能如此重要，我们应该如何使用它。

索引具有以下优点：

* 大大加快数据的检索速度
* 加速表和表之间的连接
* 使用分组和排序子句进行数据检索时，可以显著减少查询中分组和排序的时间；
* 通过创建唯一性索引，可以保证数据库表中每一行数据的唯一性；

适合创建索引的字段：

* 经常作查询选择的字段
* 经常作表连接的字段
* 经常出现在`order by`,`group by`,`distinct`后面的字段

索引的缺点：

* 创建索引和维护索引需要耗费时间，对表中的数据进行增加、删除和修改时索引也需要动态维护，降低了数据的维护速度；
* 索引需要占物理空间；

需要注意的是，**索引不是越多越好，不要对经常变动的数据加索引，小数据的表不需要索引**；

以下情况不需要添加索引：

* 在查询中很少使用或者很少参考的列不应该创建索引；
* 只有很少数据值的列不应该增加索引；
* 当修改性能远远大于检索性能时，不应该创建索引；

（2）使用 pdAdmin 恢复数据库时需要注意哪些问题？

就我的实验过程而言，首先恢复数据库时要先进行备份，备份时会出现 [错误](#error)(ctrl+单击可跳转)：`Utility file not found. Please correct the Binary Path in the Preferences dialog`错误，原因是在 pgAdmin4 中，没有指向 PostgreSQL DBMS 的可执行文件 psql 的路径，导致无法执行操作 postgresql 的命令或语句。

因此需要将postgresql的bin文件所在路径放入设置中，即可以解决问题；

恢复时，关键是找到文件所在的位置；整体感觉除了备份时遇到的错误，没有什么特别需要注意的地方~:smile:



 